- hosts: localhost
  gather_facts: false
  collections:
    - flowerysong.sensu_go
  tasks:
    - name: Create an asset
      sensu_go_asset:
        name: asset
        download_url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
        sha512: 518e7c17cf670393045bff4af318e1d35955bfde166e9ceec2b469109252f79043ed133241c4dc96501b6636a1ec5e008ea9ce055d1609865635d4f004d7187b
        filters:
          - "entity.system.os == 'linux'"
          - "entity.system.arch == 'amd64'"
          - "entity.system.platform == 'rhel'"
        annotations:
          sensio.io.bonsai.url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
          sensio.io.bonsai.tier: Community
          sensio.io.bonsai.version: 4.0.0
          sensio.io.bonsai.tags: ruby-runtime-2.4.4
      register: result

    - assert:
        that: result is changed

    - name: Test asset creation idempotence
      sensu_go_asset:
        name: asset
        download_url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
        sha512: 518e7c17cf670393045bff4af318e1d35955bfde166e9ceec2b469109252f79043ed133241c4dc96501b6636a1ec5e008ea9ce055d1609865635d4f004d7187b
        filters:
          - "entity.system.os == 'linux'"
          - "entity.system.arch == 'amd64'"
          - "entity.system.platform == 'rhel'"
        annotations:
          sensio.io.bonsai.url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
          sensio.io.bonsai.tier: Community
          sensio.io.bonsai.version: 4.0.0
          sensio.io.bonsai.tags: ruby-runtime-2.4.4
      register: result

    - assert:
        that: result is not changed

    - name: Test asset can be modified
      sensu_go_asset:
        name: asset
        download_url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
        sha512: 518e7c17cf670393045bff4af318e1d35955bfde166e9ceec2b469109252f79043ed133241c4dc96501b6636a1ec5e008ea9
        filters:
          - "entity.system.os == 'linux'"
          - "entity.system.arch == 'amd64'"
          - "entity.system.platform == 'rhel'"
        annotations:
          sensio.io.bonsai.url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
          sensio.io.bonsai.tier: Community
          sensio.io.bonsai.version: 4.0.0
          sensio.io.bonsai.tags: ruby-runtime-2.4.4
      register: result

    - assert:
        that: result is changed

    - name: Create a second asset
      sensu_go_asset:
        name: asset2
        download_url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
        sha512: 518e7c17cf670393045bff4af318e1d35955bfde166e9ceec2b469109252f79043ed133241c4dc96501b6636a1ec5e008ea9ce055d1609865635d4f004d7187b
        filters:
          - "entity.system.os == 'linux'"
          - "entity.system.arch == 'amd64'"
          - "entity.system.platform == 'rhel'"
        annotations:
          sensio.io.bonsai.url: https://assets.bonsai.sensu.io/68546e739d96fd695655b77b35b5aabfbabeb056/sensu-plugins-cpu-checks_4.0.0_centos_linux_amd64.tar.gz
          sensio.io.bonsai.tier: Community
          sensio.io.bonsai.version: 4.0.0
          sensio.io.bonsai.tags: ruby-runtime-2.4.4

    - name: Test getting all assets
      sensu_go_asset_info:

    - name: Test getting specific asset
      sensu_go_asset_info:
        name: asset
      register: result

    - assert:
        that:
          - result.assets | length == 1
          - result.assets.0.metadata.name == 'asset'
